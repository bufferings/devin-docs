---
layout: default
title: トラブルシューティング
parent: ecspresso
has_children: false
nav_order: 5
---

# トラブルシューティング

ecspressoを使用する際に発生する可能性のある一般的な問題とその解決方法を説明します。

## よくある問題と解決策

### デプロイに失敗する

#### 症状
`ecspresso deploy`コマンドが失敗し、エラーメッセージが表示される。

#### 考えられる原因と解決策

1. **タスク定義の問題**
   - **原因**: タスク定義に無効な設定がある
   - **解決策**: `ecspresso verify --task-definition`コマンドでタスク定義を検証し、エラーを修正する

2. **サービス定義の問題**
   - **原因**: サービス定義に無効な設定がある
   - **解決策**: `ecspresso verify --service-definition`コマンドでサービス定義を検証し、エラーを修正する

3. **IAM権限の不足**
   - **原因**: 必要なIAM権限がない
   - **解決策**: 以下の権限があることを確認する
     - `ecs:DescribeServices`
     - `ecs:UpdateService`
     - `ecs:RegisterTaskDefinition`
     - その他、使用する機能に応じた権限

4. **リソース制限**
   - **原因**: ECSクラスターのリソース（CPU、メモリ）が不足している
   - **解決策**: クラスターにキャパシティを追加するか、タスク定義のリソース要件を減らす

5. **ネットワーク設定の問題**
   - **原因**: VPCサブネットやセキュリティグループの設定が正しくない
   - **解決策**: ネットワーク設定を確認し、必要に応じて修正する

### タスクが起動しない

#### 症状
サービスは作成されるが、タスクが起動せず、`PENDING`状態のままになる。

#### 考えられる原因と解決策

1. **リソース不足**
   - **原因**: クラスターにタスクを実行するのに十分なリソースがない
   - **解決策**: クラスターにインスタンスを追加するか、タスク定義のリソース要件を減らす

2. **コンテナイメージの問題**
   - **原因**: コンテナイメージが存在しない、またはアクセスできない
   - **解決策**: イメージのパスとタグを確認し、ECRリポジトリへのアクセス権があることを確認する

3. **ヘルスチェックの失敗**
   - **原因**: コンテナのヘルスチェックが失敗している
   - **解決策**: アプリケーションのログを確認し、ヘルスチェックの設定を見直す

4. **ポート競合**
   - **原因**: 同じホストポートを使用する複数のタスクがある
   - **解決策**: 動的ポートマッピングを使用するか、異なるホストポートを指定する

### ロードバランサーの問題

#### 症状
タスクは実行されているが、ロードバランサーからのトラフィックが届かない。

#### 考えられる原因と解決策

1. **ターゲットグループの設定**
   - **原因**: ターゲットグループのヘルスチェック設定が適切でない
   - **解決策**: ヘルスチェックのパス、ポート、プロトコルを確認する

2. **セキュリティグループの設定**
   - **原因**: セキュリティグループがロードバランサーからのトラフィックを許可していない
   - **解決策**: セキュリティグループのインバウンドルールを確認し、必要なポートを開放する

3. **コンテナポートの設定**
   - **原因**: タスク定義のコンテナポート設定が正しくない
   - **解決策**: タスク定義のポートマッピングを確認し、正しいコンテナポートを指定する

### Blue/Greenデプロイメントの問題

#### 症状
CodeDeployを使用したBlue/Greenデプロイメントが失敗する。

#### 考えられる原因と解決策

1. **AppSpecファイルの問題**
   - **原因**: AppSpecファイルの形式が正しくない
   - **解決策**: `ecspresso verify --appspec`コマンドでAppSpecファイルを検証する

2. **CodeDeployの権限**
   - **原因**: CodeDeployサービスロールに必要な権限がない
   - **解決策**: CodeDeployサービスロールに適切な権限があることを確認する

3. **リスナーとターゲットグループの設定**
   - **原因**: リスナーとターゲットグループの設定が正しくない
   - **解決策**: ロードバランサーの設定を確認し、必要に応じて修正する

### テンプレート関数のエラー

#### 症状
テンプレート関数（`env`、`must_env`、`ssm`など）を使用した際にエラーが発生する。

#### 考えられる原因と解決策

1. **環境変数の不足**
   - **原因**: `must_env`関数で参照している環境変数が設定されていない
   - **解決策**: 必要な環境変数を設定するか、`--envfile`オプションで環境変数ファイルを指定する

2. **SSMパラメータの問題**
   - **原因**: `ssm`関数で参照しているパラメータが存在しない、またはアクセスできない
   - **解決策**: SSMパラメータの存在とアクセス権を確認する

3. **CloudFormation出力の問題**
   - **原因**: `cfn_output`関数で参照しているスタックまたは出力が存在しない
   - **解決策**: CloudFormationスタックと出力の名前を確認する

## デバッグ方法

### ログの確認

ecspressoのデバッグログを有効にするには、`--debug`オプションを使用します：

```console
$ ecspresso deploy --config ecspresso.yml --debug
```

### 差分の確認

デプロイ前に変更内容を確認するには、`diff`コマンドを使用します：

```console
$ ecspresso diff --config ecspresso.yml
```

### レンダリング結果の確認

テンプレート関数が適用された後の設定ファイルを確認するには、`render`コマンドを使用します：

```console
$ ecspresso render --config ecspresso.yml
```

### タスクの状態確認

タスクの状態を確認するには、`status`コマンドを使用します：

```console
$ ecspresso status --config ecspresso.yml --tasks
```

### ECSコンソールでの確認

AWS Management Consoleの以下の場所で詳細情報を確認できます：

1. ECSクラスターのサービス詳細ページ
2. ECSクラスターのタスク一覧ページ
3. CloudWatchログでコンテナのログを確認

## よくある質問

### Q: ecspressoはどのAWSリージョンで使用できますか？

A: ecspressoは、ECSがサポートされているすべてのAWSリージョンで使用できます。リージョンは設定ファイルで指定するか、`--region`オプションで指定できます。

### Q: 複数のAWSアカウントでecspressoを使用するにはどうすればよいですか？

A: AWS CLIのプロファイルを使用して、異なるAWSアカウントの認証情報を切り替えることができます。`--profile`オプションでプロファイルを指定します：

```console
$ ecspresso deploy --config ecspresso.yml --profile production
```

### Q: タスク定義のコンテナイメージを動的に変更するにはどうすればよいですか？

A: テンプレート関数を使用して、環境変数からイメージを設定できます：

```json
{
  "containerDefinitions": [
    {
      "name": "app",
      "image": "{{ must_env `ECR_REPOSITORY` }}:{{ must_env `IMAGE_TAG` }}"
    }
  ]
}
```

そして、デプロイ時に環境変数を設定します：

```console
$ export ECR_REPOSITORY=123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/your-repo
$ export IMAGE_TAG=v1.0.0
$ ecspresso deploy --config ecspresso.yml
```

### Q: デプロイが失敗した場合、自動的にロールバックするにはどうすればよいですか？

A: `--rollback-events`オプションを使用して、特定のイベントが発生した場合に自動的にロールバックするように設定できます：

```console
$ ecspresso deploy --config ecspresso.yml --rollback-events DEPLOYMENT_FAILURE
```

## サポートリソース

問題が解決しない場合は、以下のリソースを参照してください：

1. [ecspresso GitHub リポジトリ](https://github.com/kayac/ecspresso)
2. [ecspresso Issues](https://github.com/kayac/ecspresso/issues)
3. [AWS ECS ドキュメント](https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/Welcome.html)
