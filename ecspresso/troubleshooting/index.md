---
layout: default
title: トラブルシューティング
parent: ecspresso
nav_order: 5
---

# トラブルシューティング

ecspressoを使用する際によくある問題と解決策を紹介します。

## デプロイに関する問題

### サービスの更新に失敗する

**症状**: `ecspresso deploy`コマンドを実行すると、サービスの更新に失敗する。

**考えられる原因と解決策**:

1. **タスク定義の問題**
   - コンテナ定義が正しくない
   - リソース制限（CPU/メモリ）が不適切
   
   **解決策**: `ecspresso verify`コマンドを使用して、タスク定義を検証します。

2. **サービスロールの権限不足**
   - ECSサービスロールに必要な権限がない
   
   **解決策**: サービスロールに適切な権限を付与します。

3. **クラスターのリソース不足**
   - クラスターにタスクを実行するためのリソースがない
   
   **解決策**: クラスターのキャパシティを増やすか、タスクのリソース要件を減らします。

### Blue/Greenデプロイに失敗する

**症状**: CodeDeployを使用したBlue/Greenデプロイが失敗する。

**考えられる原因と解決策**:

1. **CodeDeployの設定ミス**
   - デプロイグループの設定が正しくない
   
   **解決策**: CodeDeployのデプロイグループ設定を確認します。

2. **ヘルスチェックの失敗**
   - 新しいタスクがヘルスチェックに合格しない
   
   **解決策**: アプリケーションのヘルスチェックエンドポイントを確認します。

## タスク実行の問題

### タスクが起動しない

**症状**: `ecspresso run`コマンドを実行しても、タスクが起動しない。

**考えられる原因と解決策**:

1. **ネットワーク設定の問題**
   - サブネットやセキュリティグループの設定が正しくない
   
   **解決策**: ネットワーク設定を確認します。

2. **コンテナイメージの問題**
   - イメージが存在しない
   - イメージの取得に失敗する
   
   **解決策**: コンテナイメージの存在と権限を確認します。

### タスクが即座に終了する

**症状**: タスクが起動後すぐに終了する。

**考えられる原因と解決策**:

1. **アプリケーションのクラッシュ**
   - アプリケーションがエラーで終了している
   
   **解決策**: `ecspresso run --watch-container=app`を使用してログを確認します。

2. **環境変数の問題**
   - 必要な環境変数が設定されていない
   
   **解決策**: タスク定義の環境変数を確認します。

## 設定に関する問題

### 環境変数が反映されない

**症状**: 環境変数ファイルを指定しても、値が反映されない。

**考えられる原因と解決策**:

1. **環境変数ファイルの形式が正しくない**
   - 形式が正しくない
   
   **解決策**: 環境変数ファイルの形式を確認します。

2. **テンプレートの参照方法が正しくない**
   - 変数の参照方法が間違っている
   
   **解決策**: テンプレート内の変数参照を確認します。

### Jsonnetファイルのエラー

**症状**: Jsonnetファイルの処理中にエラーが発生する。

**考えられる原因と解決策**:

1. **Jsonnetの構文エラー**
   - Jsonnetファイルに構文エラーがある
   
   **解決策**: Jsonnetファイルの構文を確認します。

2. **外部変数の問題**
   - 外部変数が正しく設定されていない
   
   **解決策**: `--ext-str`または`--ext-code`オプションを確認します。

## よくあるエラーメッセージと対処法

### "AccessDenied"

**エラーメッセージ**: `AccessDenied: User is not authorized to perform ecs:*`

**対処法**:
- AWS認証情報が正しく設定されているか確認
- IAMユーザー/ロールに必要な権限が付与されているか確認

### "ResourceNotFoundException"

**エラーメッセージ**: `ResourceNotFoundException: The specified cluster could not be found.`

**対処法**:
- クラスター名が正しいか確認
- リージョンが正しいか確認

### "InvalidParameterException"

**エラーメッセージ**: `InvalidParameterException: The specified task definition contains invalid parameters`

**対処法**:
- タスク定義の内容を確認
- `ecspresso verify`コマンドを使用して検証

## デバッグ方法

### ログの詳細レベルを上げる

詳細なログを表示するには、`--debug`オプションを使用します：

```console
$ ecspresso --debug deploy
```

### ドライランモードの使用

実際の変更を行わずに動作を確認するには、`--dry-run`オプションを使用します：

```console
$ ecspresso deploy --dry-run
```

### 差分の確認

現在の設定と実際のリソースの差分を確認するには、`diff`コマンドを使用します：

```console
$ ecspresso diff
```

## サポートリソース

問題が解決しない場合は、以下のリソースを参照してください：

1. [GitHub Issues](https://github.com/kayac/ecspresso/issues)
2. [ecspressoのドキュメント](https://github.com/kayac/ecspresso)
